---
title: "Enhanced Contribution Analyses"
output: html_notebook
---

This Notebook contains the code for PSF's estimations of enhanced contribution to harvest as they've been presented in our Harvest Report. Total catch data was compiled for commercial and recreational fisheries in the 'catch_data_wrangle.Rmd' and are used here to look at total catch. Hatchery catch information was obtained from expanded CWT recoveries from EPAD, which were then _extended_ to account for ALL hatchery production (ie. including releases that were not associated with a CWT). 

Chum enhanced contribution data were provided by Cheryl Lynch from the 2020 Chum Assessment (Lynch et al. 2020).

See report for full description of methods.

An alternate approach using CTC data is explored at the bottom, however this method was not pursued/included for the final report due to issues in properly assigning fisheries to catch.

```{r import}
library(tidyverse)
library(here)
library(RColorBrewer)
library(ggpubr)
library(scales)

# Read in catch data (total and hatchery) (data files generated in the 'catch_data_wrangle.Rmd' script)
total_catch <- read_csv(here("processed", "total_catch.csv"))
CN_all_catch <- read_csv(here("processed", "CN_ALL_catch.csv"))
CO_all_catch <- read_csv(here("processed", "CO_ALL_catch.csv"))

# Expanded CWT catch data by fishery for CN from EPAD (data files tidied in the 'catch_data_wrangle.Rmd' script)
CN_dat <- read_csv(here("processed", "CN_EPAD_tidy.csv"))

# Expanded CWT catch by fishery data for CO from EPAD
CO_dat <- read_csv(here("processed", "CO_EPAD_tidy.csv"))

# Chum dat from Lynch et al. 2020 (raw data processed in the 'chum_wrangle.Rmd' script)
CM_dat <- read_csv(here("processed", "chum_all.csv"))

# Bring in production plan objectives (file generated in the 'objectives.Rmd' script)
PP <- read_csv(here("processed", "PP_objectives.csv"))

```

```{r Total Catch}
# Generate plots of total salmon catches by fishery for each stat area for each species
# Plot all as bar charts
ggplot(subset(total_catch, species == "Chinook"), aes(x = year, y = catch, fill = fishery)) +
  geom_bar(stat = "identity", position = "stack", colour = "black", size = 0.2) +
  facet_wrap(~area, scales = "free_y", ncol = 4) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "top",
        legend.justification = "right",
        legend.key.size = unit(0.8, "line")) +
  labs(y = "Total Catch", fill = "Fishery") +
  scale_y_continuous(labels = comma)
#ggsave("../figs/totcatch/AllBC_CN_totcatch_bar.png", width = 20, height = 22, units = "cm")


ggplot(subset(total_catch, species == "Coho"), aes(x = year, y = catch, fill = fishery)) +
  geom_bar(stat = "identity", position = "stack", colour = "black", size = 0.2) +
  facet_wrap(~area, scales = "free_y", ncol = 4) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "top",
        legend.justification = "right",
        legend.key.size = unit(0.8, "line")) +
  labs(y = "Total Catch", fill = "Fishery") +
  scale_y_continuous(labels = comma)
#ggsave("../figs/totcatch/AllBC_CO_totcatch_bar.png", width = 20, height = 22, units = "cm")

ggplot(subset(total_catch, species == "Chum"), aes(x = year, y = catch, fill = fishery)) +
  geom_bar(stat = "identity", position = "stack", colour = "black", size = 0.2) +
  facet_wrap(~area, scales = "free_y", ncol = 4) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "top",
        legend.justification = "right",
        legend.key.size = unit(0.8, "line")) +
  labs(y = "Total Catch", fill = "Fishery") +
  scale_y_continuous(labels = comma)
#ggsave("../figs/totcatch/AllBC_CM_totcatch_bar.png", width = 20, height = 22, units = "cm")

# Get summaries of the mean total annual catch for different time periods and regions
avg_catch_time <- total_catch %>%
  filter(year > 2009) %>% # filter to look at Commercial only when looking at NCBC data
  mutate(region = case_when(area %in% c(1:10) ~ "NCBC",
                            TRUE ~ "SBC")) %>%
  group_by(year, region) %>%
  summarise(totcatch = sum(catch, na.rm = T)) %>%
  group_by(region) %>%
  mutate(meancatch = mean(totcatch), sdcatch = sd(totcatch))


```

```{r Appendix A Total Catch tables}
# Create summary tables of total catch by fishery type by region for Tables in Appendix A of Harvest Report
CN_totcatch <- total_catch %>%
  ungroup() %>%
  filter(species == "Chinook") %>%
  select(year, area, catch, fishery) %>%
  mutate(region = case_when(area %in% c(1:5) ~ "NCST",
                            area %in% c(6:10, 130) ~ "CCST",
                            area %in% c(11:19, 28:29) ~ "ISC",
                            area %in% c(20:27) ~ "WCVI")) %>%
  select(-area) %>%
  mutate(fishery = as.character(fishery)) %>%
  mutate(fishery = case_when(fishery %in% c("GN", "SN") ~ "Net",
                            fishery == "T" ~ "Troll",
                            fishery == "rec" ~ "Rec",
                            TRUE ~ fishery)) %>%
  select(year, region, fishery, catch) %>%
  group_by(year, region, fishery) %>%
  summarise(catch = sum(catch, na.rm = T)) %>%
  unite(col = region_fishery, region, fishery, sep = "_", remove = T) %>%
  pivot_wider(names_from = region_fishery, values_from = catch) %>%
  select(year, NCST_Net, NCST_Troll, NCST_Rec, CCST_Net, CCST_Troll, CCST_Rec, WCVI_Net, WCVI_Troll, WCVI_Rec, ISC_Net, ISC_Troll, ISC_Rec)
#write_csv(CN_totcatch, "../processed/outputs/CN_totcatch.csv")


CO_totcatch <- total_catch %>%
  ungroup() %>%
  filter(species == "Coho") %>%
  select(year, area, catch, fishery) %>%
  mutate(region = case_when(area %in% c(1:5) ~ "NCST",
                            area %in% c(6:10, 130) ~ "CCST",
                            area %in% c(11:19, 28:29) ~ "ISC",
                            area %in% c(20:27) ~ "WCVI")) %>%
  select(-area) %>%
  mutate(fishery = as.character(fishery)) %>%
  mutate(fishery = case_when(fishery %in% c("GN", "SN") ~ "Net",
                            fishery == "T" ~ "Troll",
                            fishery == "rec" ~ "Rec",
                            TRUE ~ fishery)) %>%
  select(year, region, fishery, catch) %>%
  group_by(year, region, fishery) %>%
  summarise(catch = sum(catch, na.rm = T)) %>%
  unite(col = region_fishery, region, fishery, sep = "_", remove = T) %>%
  pivot_wider(names_from = region_fishery, values_from = catch) %>%
  select(year, NCST_Net, NCST_Troll, NCST_Rec, CCST_Net, CCST_Troll, CCST_Rec, WCVI_Net, WCVI_Troll, WCVI_Rec, ISC_Net, ISC_Troll, ISC_Rec)
#write_csv(CO_totcatch, "../processed/outputs/CO_totcatch.csv")

CM_totcatch <- total_catch %>%
  ungroup() %>%
  filter(species == "Chum") %>%
  select(year, area, catch, fishery) %>%
  mutate(region = case_when(area %in% c(1:5) ~ "NCST",
                            area %in% c(6:10, 130) ~ "CCST",
                            area %in% c(11:19, 28:29) ~ "ISC",
                            area %in% c(20:27) ~ "WCVI")) %>%
  select(-area) %>%
  mutate(fishery = as.character(fishery)) %>%
  mutate(fishery = case_when(fishery %in% c("GN", "SN") ~ "Net",
                            fishery == "T" ~ "Troll",
                            fishery == "rec" ~ "Rec",
                            TRUE ~ fishery)) %>%
  select(year, region, fishery, catch) %>%
  group_by(year, region, fishery) %>%
  summarise(catch = sum(catch, na.rm = T)) %>%
  unite(col = region_fishery, region, fishery, sep = "_", remove = T) %>%
  pivot_wider(names_from = region_fishery, values_from = catch) %>%
  select(year, NCST_Net, NCST_Troll, NCST_Rec, CCST_Net, CCST_Troll, CCST_Rec, WCVI_Net, WCVI_Troll, WCVI_Rec, ISC_Net, ISC_Troll, ISC_Rec)
#write_csv(CM_totcatch, "../processed/outputs/CM_totcatch.csv")


```

The following code calculates epxanded cWT catch, our extended hatchery catch, and enhanced contribution to total catch based on these values. 
Generates Appendix A Tables for CN


```{r Tot Hatch Catch and Enhanced contr Tables}
# Look at enhanced contribution to overall catch by region and expand by the mark rate (calculated in the unmarked.Rmd by comparing CWT releases to non-CWT releases for each year and region)

#---- Chinook ----
# Read in the CWT-mark rates - adjust year by 3 years to convert from release year to recovery year of 4-yr olds
mark_props <- read_csv(here("processed", "mark_props.csv")) %>%
  filter(species == "Chinook") %>%
  mutate(year = relY+3) %>%
  select(-c(species, relY)) %>%
  filter(CWT_rate > 0)

# Add mark rates (proportion associated with CWT) to SBC catch data to expand to all hatchery fish
Ext_catch_CN <- left_join(CN_all_catch, mark_props, by = c("year", "region"))

# Calculate extended hatchery catch and enhanced contributions on a regional scale (** NOTE: Total catch for NCST and CCST is based on commercial catch data only and thus enhanced contribution calcs are not accurate up until 2013 (when iREC starts). Fill these 2 columns with NA up to 2013 for report tables)
# Produces data for TAbles A.4, A.7, A.10, and A.13 in Appendix A of Harvest report)
regional_enhctr_CN <- Ext_catch_CN %>%
  # filter(year > 1980) %>% # Need to filter to only look at 1981 onwards for enh contribution calcs since only commercial data prior to 1981, but show all data for hatchery plots in next code chunk
  group_by(year, region) %>%
  mutate(`Exp CWT` = sum(CWT_catch, na.rm = T), `Total Hatchery` = `Exp CWT`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T), `Enhanced Contribution` = `Total Hatchery`/`Total Catch`) %>%
  select(1:2, 8:11) %>%
  distinct() %>%
  mutate(region = factor(region, levels = c("NCST", "CCST", "WCVI", "ISC"))) %>%
  arrange(region)
write_csv(regional_enhctr_CN, "../processed/outputs/CN_enhctr.csv")

# Calculate the overall mean enhanced contribution for WCVI and ISC
mean_enhctr_CN_SBC <- regional_enhctr_CN %>%
  filter(region %in% c("WCVI", "ISC")) %>%
  group_by(region) %>%
  summarise(mean_enhctr = mean(`Enhanced Contribution`, na.rm = T), sd = sd(`Enhanced Contribution`, na.rm = T))

# Calculate the mean enhanced contribution for NCST and CCST (has to be from 2013 onwards as these are the only years for which we have rec and commercial catch)
mean_enhctr_CN_NBC <- regional_enhctr_CN %>%
  filter(region %in% c("NCST", "CCST"), year > 2012) %>%
  group_by(region) %>%
  summarise(mean_enhctr = mean(`Enhanced Contribution`, na.rm = T), sd = sd(`Enhanced Contribution`, na.rm = T))



# ---- COHO ----
# Read in the CWT-mark rates - adjusted by 2 years to convert release year to recovery year of 3-yr olds
mark_props_CO <- read_csv(here("processed", "mark_props.csv")) %>%
  filter(species == "Coho") %>%
  mutate(year = relY+2) %>%
  select(-c(species, relY))

# Add mark rates (proportion associated with CWT) to SBC catch data to expand to all hatchery fish
Ext_catch_CO <- left_join(CO_all_catch, mark_props_CO, by = c("year", "region"))

# Calculate extended hatchery catch and enhanced contributions on a regional scale (** NOTE: Total catch for NCST and CCST is based on commercial catch data only and thus enhanced contribution calcs are not accurate up until 2013 (when iREC starts). Fill these 2 columns with NA for years prior to 2013 in report tables)
# Produces data for TAbles A.5, A.8, A.11, and A.14 in Appendix A of Harvest report)
regional_enhctr_CO <- Ext_catch_CO %>%
  #filter(year > 1980) %>% # Need to filter to only look at 1981 onwards for enh contribution calcs since only commercial data prior to 1981, but show all data for hatchery plots in next code chunk
  group_by(year, region) %>%
  mutate(`Exp CWT` = sum(CWT_catch, na.rm = T), `Total Hatchery` = `Exp CWT`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T), `Enhanced Contribution` = `Total Hatchery`/`Total Catch`) %>%
  select(1:2, 8:11) %>%
  distinct() %>%
  mutate(region = factor(region, levels = c("NCST", "CCST", "WCVI", "ISC"))) %>%
  arrange(region) 
write_csv(regional_enhctr_CO, "../processed/outputs/CO_enhctr.csv")

# Calculate the overall mean enhanced contribution per region
mean_enhctr_CO <- regional_enhctr_CO %>%
  group_by(region) %>%
  summarise(mean_enhctr = mean(`Enhanced Contribution`, na.rm = T), sd = sd(`Enhanced Contribution`, na.rm = T))
  
```

The following code generates Figures 9-10 in the Harvest report showing expanded CWT catch, extended hatchery catch, and total catch

```{r Hatchery Catch}
# First plot expanded CWT hatchery catch vs our extended hatchery catch vs total catch (Figures 9-10 in report)

# ---- CN ----
# Convert to long format for plotting
hatch_catch_CN <- regional_enhctr_CN %>%
  pivot_longer(cols = 3:4, names_to = "type", values_to = "catch")

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot expanded CWT recoveries, total hatchery catch, and total overall catch in same plot. Only add in total catch line for SBC areas as NCST and CCST data are commercial catch data only and not equivalent
ggplot(hatch_catch_CN, aes(x = year, y = catch)) +
  geom_bar(aes(fill = type), stat = "identity", position = "dodge", color = "black", size = 0.1) +
  geom_line(data = subset(hatch_catch_CN, region %in% c("WCVI", "ISC") & year > 1980), aes(x = year, y = `Total Catch`, color = "Total Catch"), size = 0.4) +
  facet_wrap(~region, scales = "free_y") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        legend.position = "bottom",
        legend.key.size = unit(0.7, "line"),
        legend.title = element_blank()) +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = "#000000") +
  scale_fill_manual(values = cols) +
  labs(y = "Total Annual Catch", fill = "Hatchery Data Type")
ggsave("../figs/totcatch/total_hatch_catch_CN.png", width = 18, height = 13, units = "cm")


# ---- CO -----
hatch_catch_CO <- regional_enhctr_CO %>%
  pivot_longer(cols = 3:4, names_to = "type", values_to = "catch")

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot expanded CWT recoveries, total hatchery catch, and total overall catch in same plot
ggplot(hatch_catch_CO, aes(x = year, y = catch)) +
  geom_bar(aes(fill = type), stat = "identity", position = "dodge", color = "black", size = 0.1) +
  geom_line(data = subset(hatch_catch_CO, region %in% c("WCVI", "ISC") & year > 1980), aes(x = year, y = `Total Catch`, color = "Total Catch"), size = 0.4) +
  facet_wrap(~region, scales = "free_y") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        legend.position = "bottom",
        legend.key.size = unit(0.7, "line"),
        legend.title = element_blank()) +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = "#000000") +
  scale_fill_manual(values = cols) +
  labs(y = "Total Annual Catch", fill = "Hatchery Data Type")
ggsave("../figs/totcatch/total_hatch_catch_CO.png", width = 18, height = 13, units = "cm")

```

The following code generates Figures 12-17 in the Harvest Report showing enhanced contributions to catch for CN and CO. Note, total catch (commercial + rec) is only available for the NCST and CCST from 2013 onwards (the first complete year of iREC reporting), while data go back to 1981 for the ISC and WCVI regions.

```{r Enhanced contribution}
# Create bar chart of total catch with proportion of BC hatchery fish shown in plot below - focused on SBC since we don't have total catch for NBC
# Identify hatchery vs non-hatchery catch

# ---- NBC CN ----
NBC_regional_enhctr_CN <- Ext_catch_CN %>%
  select(1:2, 5:7) %>%
  distinct() %>%
  filter(region %in% c("NCST", "CCST"), year > 2012) %>% #2013 = first complete year of iREC data
  group_by(year, region) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Catch` = sum(tot_catch, na.rm = T)) %>%
  select(-c(3:4)) %>%
  distinct() %>%
  mutate(`BC Hatchery` = `CWT Catch`/CWT_rate, Other = `Total Catch` - `BC Hatchery`) %>%
  pivot_longer(6:7, names_to = "source", values_to = "catch") %>%
  mutate(source = factor(source, levels = c("Other", "BC Hatchery")), region = factor(region, levels = c("NCST", "CCST"))) %>%
  filter(catch > 0) 

# Plot of total CN catch
totcatch_NBC_CN <- ggplot(NBC_regional_enhctr_CN, aes(x = year, y = `Total Catch`)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_NBC_CN

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_NBC_CN <- ggplot(NBC_regional_enhctr_CN, aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_NBC_CN

# Combine the two plots to make Figure 12
ggarrange(totcatch_NBC_CN, hatch_props_NBC_CN, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/NBC_totcatch_hatchprops_CN.png", width = 15, height = 11, units = "cm")



# ---- SBC CN ----
SBC_regional_enhctr_CN <- Ext_catch_CN %>%
  select(1:2, 5:7) %>%
  distinct() %>%
  filter(region %in% c("ISC", "WCVI"), year > 1981 & year < 2020) %>% #the first and last years of data suggest incomplete catch reporting so exclude
  group_by(year, region) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Catch` = sum(tot_catch, na.rm = T)) %>%
  select(-c(3:4)) %>%
  distinct() %>%
  mutate(`BC Hatchery` = `CWT Catch`/CWT_rate, Other = `Total Catch` - `BC Hatchery`) %>%
  pivot_longer(6:7, names_to = "source", values_to = "catch") %>%
  mutate(source = factor(source, levels = c("Other", "BC Hatchery")), region = factor(region, levels = c("WCVI", "ISC"))) %>%
  filter(catch > 0) 

# Plot of total CN catch
totcatch_SBC_CN <- ggplot(SBC_regional_enhctr_CN, aes(x = year, y = `Total Catch`)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_SBC_CN

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_SBC_CN <- ggplot(SBC_regional_enhctr_CN, aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_SBC_CN

# Combine the two plots to make Figure 12
ggarrange(totcatch_SBC_CN, hatch_props_SBC_CN, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/SBC_totcatch_hatchprops_CN.png", width = 18, height = 14, units = "cm")



# ---- NBC CO ----
NBC_regional_enhctr_CO <- Ext_catch_CO %>%
  select(1:2, 5:7) %>%
  distinct() %>%
  filter(region %in% c("NCST", "CCST"), year > 2012) %>% #2013 = first complete year of iREC data
  group_by(year, region) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Catch` = sum(tot_catch, na.rm = T)) %>%
  select(-c(3:4)) %>%
  distinct() %>%
  mutate(`BC Hatchery` = `CWT Catch`/CWT_rate, Other = `Total Catch` - `BC Hatchery`) %>%
  pivot_longer(6:7, names_to = "source", values_to = "catch") %>%
  mutate(source = factor(source, levels = c("Other", "BC Hatchery")), region = factor(region, levels = c("NCST", "CCST"))) %>%
  filter(catch > 0) 

# Plot of total CN catch
totcatch_NBC_CO <- ggplot(NBC_regional_enhctr_CO, aes(x = year, y = `Total Catch`)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_NBC_CO

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_NBC_CO <- ggplot(NBC_regional_enhctr_CO, aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_NBC_CO

# Combine the two plots to make Figure 13 from Harvest Report
ggarrange(totcatch_NBC_CO, hatch_props_NBC_CO, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/NBC_totcatch_hatchprops_CO.png", width = 15, height = 11, units = "cm")



# ---- SBC CO ----
SBC_regional_enhctr_CO <- Ext_catch_CO %>%
  select(1:2, 5:7) %>%
  distinct() %>%
  filter(region %in% c("ISC", "WCVI"), year > 1980 & year < 2020) %>% #the first and last years of data suggest incomplete catch reporting so exclude
  group_by(year, region) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Catch` = sum(tot_catch, na.rm = T)) %>%
  select(-c(3:4)) %>%
  distinct() %>%
  mutate(`BC Hatchery` = `CWT Catch`/CWT_rate, Other = `Total Catch` - `BC Hatchery`) %>%
  pivot_longer(6:7, names_to = "source", values_to = "catch") %>%
  mutate(source = factor(source, levels = c("Other", "BC Hatchery")), region = factor(region, levels = c("WCVI", "ISC"))) %>%
  filter(catch > 0) 

# Plot of total CN catch
totcatch_SBC_CO <- ggplot(SBC_regional_enhctr_CO, aes(x = year, y = `Total Catch`)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_SBC_CO

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_SBC_CO <- ggplot(SBC_regional_enhctr_CO, aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_SBC_CO

# Combine the two plots to make Figure 13 from Harvest Report
ggarrange(totcatch_SBC_CO, hatch_props_SBC_CO, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/SBC_totcatch_hatchprops_CO.png", width = 18, height = 14, units = "cm")



# Plot annual enhanced contribution by region for CN (Note NCST and CCST plots inaccurate prior to 2013 - only based on commercial catch but all CWT recoveries - do not use, just exploratory)
ggplot(regional_enhctr_CN, aes(x = year, y = `Enhanced Contribution`)) +
  geom_bar(stat = "identity") +
  facet_wrap(~region) +
  theme_bw() +
  theme(axis.title.x = element_blank()) +
  labs(y = "Enhanced Contribution to Catch") +
  scale_y_continuous(expand = c(0.01,0), limits = c(0, 1))
ggsave("../figs/SBC_enhctr_byregion_CN.png", width = 20, height = 12, units = "cm")

```

The following code generates Figures 18-25 in the Harvest Report

```{r Enhanced Contribution by Fishery by Region}

# ---- CN ----

## Look at enhanced contribution to each FISHERY in each region
# Get the numbers for a table first, then prepare data for plotting
mean_enhctr_fishery_CN <- Ext_catch_CN %>%
  filter(case_when(region %in% c("NCST", "CCST") ~ year > 2012, T ~ year > 1981)) %>% #only looks at years with iREC data for NCST and CCST but >1981 for SBC
  filter(fishery != "Other") %>%
  group_by(year, region, fishery) %>%
  mutate(fishery = factor(fishery, levels = c("Net", "Troll", "Rec"))) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Hatchery Catch` = `CWT Catch`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T), `Enhanced Contribution` = `Total Hatchery Catch`/`Total Catch`) %>%
  select(1:4, 9:11) %>%
  distinct() %>%
  filter(!`Enhanced Contribution` %in% c(Inf, 'NA'), `Enhanced Contribution` <1, `Total Catch` > 1) %>%
  ungroup() %>%
  group_by(region, fishery) %>%
  summarise(mean_enhctr = mean(`Enhanced Contribution`), sd = sd(`Enhanced Contribution`))

# Prepare data for plotting total catch
fishery_enhctr_CN <- Ext_catch_CN %>%
  filter(case_when(region %in% c("NCST", "CCST") ~ year > 2012, T ~ year > 1981)) %>% #only looks at years with iREC data for NCST and CCST but >1981 for SBC
  filter(fishery != "Other") %>%
  mutate(fishery = factor(fishery, levels = c("Net", "Troll", "Rec"))) %>%
  group_by(year, region, type, fishery) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Hatchery Catch` = `CWT Catch`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T)) %>%
  select(1:4, 9:10) %>%
  distinct() %>%
  pivot_longer(5:6, names_to = "source", values_to = "catch") 


# Calculate the expanded hatchery catch and non-hatch catch for WCVI and ISC
fishery_props_CN <- Ext_catch_CN %>%
  filter(case_when(region %in% c("NCST", "CCST") ~ year > 2012, T ~ year > 1981)) %>% #only looks at years with iREC data for NCST and CCST but >1981 for SBC
  filter(fishery != "Other") %>%
  mutate(fishery = factor(fishery, levels = c("Net", "Troll", "Rec"))) %>%
  group_by(year, region, type, fishery) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `BC Hatchery` = `CWT Catch`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T),Other = `Total Catch` - `BC Hatchery`) %>%
  select(1:4, 9, 11) %>%
  distinct() %>%
  pivot_longer(5:6, names_to = "source", values_to = "catch") %>%
  mutate(source = factor(source, levels = c("Other", "BC Hatchery"))) %>%
  filter(catch > 0)


# Create a plot of total catch by fishery with enhanced contribution below it for each region

## --- NCST ---
# Plot of total CN catch for NCST:
totcatch_NCST_CN <- ggplot(subset(fishery_enhctr_CN, source == "Total Catch" & region == "NCST"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_NCST_CN

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_NCST_CN <- ggplot(subset(fishery_props_CN, region == "NCST"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.key.size = unit(0.7, "line"),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_NCST_CN

# Combine to make Figure 18
ggarrange(totcatch_NCST_CN, hatch_props_NCST_CN, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_NCST_CN.png", width = 16, height = 11, units = "cm")



## --- CCST ---
# Plot of total CN catch for ISC:
totcatch_CCST_CN <- ggplot(subset(fishery_enhctr_CN, source == "Total Catch" & region == "CCST" & fishery != "Troll"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_CCST_CN

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_CCST_CN <- ggplot(subset(fishery_props_CN, region == "CCST"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.key.size = unit(0.7, "line"),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_CCST_CN

# Combine to make Figure 19
ggarrange(totcatch_CCST_CN, hatch_props_CCST_CN, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_CCST_CN.png", width = 16, height = 11, units = "cm")



## --- WCVI ---
# Plot of total CN catch WCVI
totcatch_WCVI_CN <- ggplot(subset(fishery_enhctr_CN, source == "Total Catch" & region == "WCVI"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_WCVI_CN

cols = hue_pal()(2)

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_WCVI_CN <- ggplot(subset(fishery_props_CN, region == "WCVI"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.key.size = unit(0.7, "line"),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_WCVI_CN

# Combine to make Figure 20
ggarrange(totcatch_WCVI_CN, hatch_props_WCVI_CN, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_WCVI_CN.png", width = 18, height = 12, units = "cm")



## --- ISC ---
# Plot of total CN catch for ISC:
totcatch_ISC_CN <- ggplot(subset(SBC_fishery_enhctr_CN, source == "Total Catch" & region == "ISC"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_ISC_CN

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_ISC_CN <- ggplot(subset(SBC_fishery_props_CN, region == "ISC"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.key.size = unit(0.7, "line"),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_ISC_CN

# Combine to make Figure 21
ggarrange(totcatch_ISC_CN, hatch_props_ISC_CN, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_ISC_CN.png", width = 18, height = 12, units = "cm")



# ---- CO ----

# Look at enhanced contribution to each fishery in each region
# Get the numbers for a table first, then prepare data for plotting
mean_enhctr_fishery_CO <- Ext_catch_CO %>%
  filter(case_when(region %in% c("NCST", "CCST") ~ year > 2012, T ~ year > 1981)) %>% #only looks at years with iREC data for NCST and CCST but >1981 for SBC
  filter(fishery != "Other") %>%
  mutate(fishery = factor(fishery, levels = c("Net", "Troll", "Rec"))) %>%
  group_by(year, region, type, fishery) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Hatchery Catch` = `CWT Catch`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T), `Enhanced Contribution` = `Total Hatchery Catch`/`Total Catch`) %>%
  select(1:4, 9:11) %>%
  distinct() %>%
  filter(!`Enhanced Contribution` %in% c(Inf, 'NA'), `Enhanced Contribution` <1, `Total Catch` > 1) %>%
  ungroup() %>%
  group_by(region, fishery) %>%
  summarise(mean_enhctr = mean(`Enhanced Contribution`), sd = sd(`Enhanced Contribution`))

fishery_enhctr_CO <- Ext_catch_CO %>%
  filter(case_when(region %in% c("NCST", "CCST") ~ year > 2012, T ~ year > 1981)) %>% #only looks at years with iREC data for NCST and CCST but >1981 for SBC
  filter(fishery != "Other") %>%
  mutate(fishery = factor(fishery, levels = c("Net", "Troll", "Rec"))) %>%
  group_by(year, region, type, fishery) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `Total Hatchery Catch` = `CWT Catch`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T)) %>%
  select(1:4, 9:10) %>%
  distinct() %>%
  pivot_longer(5:6, names_to = "source", values_to = "catch") 

# Calculate the expanded hatchery catch and non-hatch catch
fishery_props_CO <- Ext_catch_CO %>%
  filter(case_when(region %in% c("NCST", "CCST") ~ year > 2012, T ~ year > 1981)) %>% #only looks at years with iREC data for NCST and CCST but >1981 for SBC
  filter(fishery != "Other") %>%
  mutate(fishery = factor(fishery, levels = c("Net", "Troll", "Rec"))) %>%
  group_by(year, region, type, fishery) %>%
  mutate(`CWT Catch` = sum(CWT_catch, na.rm = T), `BC Hatchery` = `CWT Catch`/CWT_rate, `Total Catch` = sum(tot_catch, na.rm = T),Other = `Total Catch` - `BC Hatchery`) %>%
  select(1:4, 9, 11) %>%
  distinct() %>%
  pivot_longer(5:6, names_to = "source", values_to = "catch") %>%
  mutate(source = factor(source, levels = c("Other", "BC Hatchery"))) %>%
  filter(catch > 0)



# Create a plot of total catch by fishery with enhanced contribution below it for both WCVI and ISC

## --- NCST ---
# Plot of total CO catch for NCST
totcatch_NCST_CO <- ggplot(subset(fishery_enhctr_CO, source == "Total Catch" & region == "NCST"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_NCST_CO

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_NCST_CO <- ggplot(subset(fishery_props_CO, region == "NCST"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        legend.key.size = unit(0.7, "line")) +
  scale_fill_manual(values = rev(cols), labels = c("Other", "BC_Hatchery")) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_NCST_CO

# Combine to make Figure 22
ggarrange(totcatch_NCST_CO, hatch_props_NCST_CO, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_NCST_CO.png", width = 18, height = 12, units = "cm")



## --- CCST ---
# Plot of total CO catch for CCST
totcatch_CCST_CO <- ggplot(subset(fishery_enhctr_CO, source == "Total Catch" & region == "CCST"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_CCST_CO

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_CCST_CO <- ggplot(subset(fishery_props_CO, region == "CCST"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        legend.key.size = unit(0.7, "line")) +
  scale_fill_manual(values = rev(cols), labels = c("Other", "BC_Hatchery")) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_CCST_CO

# Combine to make Figure 23
ggarrange(totcatch_CCST_CO, hatch_props_CCST_CO, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_CCST_CO.png", width = 16, height = 11, units = "cm")



## --- WCVI ---
# Plot of total CO catch for WCVI
totcatch_WCVI_CO <- ggplot(subset(fishery_enhctr_CO, source == "Total Catch" & region == "WCVI"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_WCVI_CO

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_WCVI_CO <- ggplot(subset(fishery_props_CO, region == "WCVI"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        legend.key.size = unit(0.7, "line")) +
  scale_fill_manual(values = rev(cols), labels = c("Other", "BC_Hatchery")) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_WCVI_CO

# Combine to make Figure 24
ggarrange(totcatch_WCVI_CO, hatch_props_WCVI_CO, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_WCVI_CO.png", width = 18, height = 12, units = "cm")



# Plot total catches by fishery for ISC
totcatch_ISC_CO <- ggplot(subset(fishery_enhctr_CO, source == "Total Catch" & region == "ISC"), aes(x = year, y = catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_ISC_CO

# Plot the proportions of hatchery and non-hatchery catch for ISC CO
hatch_props_ISC_CO <- ggplot(subset(fishery_props_CO, region == "ISC"), aes(x = year, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~fishery, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.key.size = unit(0.7, "line"),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = rev(cols), labels = c("Other", "BC_Hatchery")) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_ISC_CO

# Combine to make Figure 25
ggarrange(totcatch_ISC_CO, hatch_props_ISC_CO, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_ISC_CO.png", width = 18, height = 12, units = "cm")

```

The following code generates the enhanced contribution figures for Chum (Figures 16 and 17 and )
Note, these data are from Lynch et al (2020), however the data only pertain to net fisheries, not troll or rec.

```{r CHUM Enhanced Contribution}
chum_dist <- CM_dat %>%
  mutate(region = case_when(area %in% c("2W,2E", "3,4,5", "1", "1,2W") ~ "NCST",
                            area %in% c("7,8,9", "6",  "8,9,10",  "9,10", "10", "6,7") ~ "CCST",
                            area %in% c("11", "14", "17", "18,19", "17,18", "15,16", "29") ~ "ISC",
                            TRUE ~ "WCVI")) %>%
  group_by(stock, recY, region) %>%
  mutate(h_catch = sum(adj_catch))

# Create summary table of catch by region - Manually broke the resulting csv into Tables A.6, A.9, A.12, and A.15 in Appendix A
chum_tab <- chum_dist %>%
  ungroup() %>%
  select(region, recY, adj_catch, totcatch) %>%
  group_by(region, recY) %>%
  mutate(annual_adj_catch = sum(adj_catch, na.rm = T)) %>%
  select(region, recY, annual_adj_catch, totcatch) %>%
  distinct() %>%
  group_by(region, recY) %>%
  mutate(totcatch = sum(totcatch, na.rm = T)) %>%
  distinct() %>%
  mutate(enh_contr = annual_adj_catch/totcatch) %>%
  mutate(region = factor(region, levels = c("NCST", "CCST", "WCVI", "ISC")))
write_csv(chum_tab, "../processed/outputs/chum_annual_catch_byregion.csv")

# Calculate the mean enhanced contribution by region over the entire time period 
mean_enhctr_CM <- chum_tab %>%
  group_by(region) %>%
  summarise(mean_enhctr = mean(enh_contr, na.rm = T), sd = sd(enh_contr, na.rm = T))

# Plot enhanced contribution to catch for each region
ggplot(chum_tab, aes(x = recY, y = enh_contr)) +
  geom_bar(stat = "identity") +
  facet_wrap(~region) +
  theme_bw() +
  theme(axis.title.x = element_blank()) +
  labs(y = "Enhanced Contribution to Catch") +
  scale_y_continuous(expand = c(0.01,0), limits = c(0, 1))
#ggsave("../figs/harvest/totcatch/SBC_enhctr_byregion_CM.png", width = 20, height = 16, units = "cm")


# Plot total and hatchery catch over time (Figure 11 in report)
chum_tab1 <- chum_tab %>%
  select(1:4) %>%
  rename(Hatchery = annual_adj_catch, `Total Catch` = totcatch) %>%
  mutate(region = factor(region, levels = c("NCST", "CCST", "WCVI", "ISC"))) 

# Plot expanded CWT recoveries, total hatchery catch, and total overall catch in same plot
ggplot(chum_tab1, aes(x = recY)) +
  geom_bar(aes(y = Hatchery, fill = "Hatchery"), stat = "identity", position = "dodge", color = "black", size = 0.1) +
  geom_line(aes(y = `Total Catch`, colour = "Total Catch"), size = 0.4) +
  facet_wrap(~region, scales = "free_y") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        legend.position = "bottom",
        legend.key.size = unit(0.7, "line"),
        legend.title = element_blank()) +
  scale_y_continuous(labels = comma) +
  scale_color_manual(values = "#000000") +
  scale_fill_manual(values = rev(cols)) +
  labs(y = "Total Annual Catch", fill = "Hatchery Data Type")
ggsave("../figs/totcatch/total_hatch_catch_CM.png", width = 18, height = 13, units = "cm")



#Prepare data for showing hatch vs non-hatch catch in bar graphs for Figures 16 and 17
chum_tab2 <- chum_tab %>%
  mutate(Other = totcatch-annual_adj_catch) %>%
  select(1:3,6) %>%
  rename(`BC Hatchery` = annual_adj_catch) %>%
  pivot_longer(cols = 3:4, names_to = "source", values_to = "catch") %>%
  mutate(source = factor(source, levels = c("Other", "BC Hatchery")), region = factor(region, levels = c("NCST", "CCST", "WCVI", "ISC"))) %>%
  filter(catch > 1)

## ---- NBC ---- ##
# Plot of total CM catch
totcatch_NBC_CM <- ggplot(subset(chum_tab, region %in% c("NCST", "CCST")), aes(x = recY, y = totcatch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~region, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_NBC_CM

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_NBC_CM <- ggplot(subset(chum_tab2, region %in% c("NCST", "CCST")), aes(x = recY, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_NBC_CM

# Combine to create Figure 16 in report
ggarrange(totcatch_NBC_CM, hatch_props_NBC_CM, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_NBC_CM.png", width = 18, height = 14, units = "cm")



## ---- SBC ---- ##
# Plot of total CM catch
totcatch_SBC_CM <- ggplot(subset(chum_tab, region %in% c("WCVI", "ISC")), aes(x = recY, y = totcatch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "white", size = 0.3) +
  facet_wrap(~region, scales = "free_y") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank()) +
  scale_y_continuous(label = comma) +
  labs(y = "Total Catch")
totcatch_SBC_CM

# Set red and blue colours for figure
cols = hue_pal()(2)

# Plot the proportions of hatchery and non-hatchery catch
hatch_props_SBC_CM <- ggplot(subset(chum_tab2, region %in% c("WCVI", "ISC")), aes(x = recY, y = catch, fill = source)) +
  geom_bar(stat = "identity", position = "fill", colour = "white", size = 0.3) +
  facet_wrap(~region) +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title.x = element_blank(),
        strip.text.x = element_blank()) +
  scale_fill_manual(values = rev(cols)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Catch")
hatch_props_SBC_CM

# Combine to create Figure 17 in report
ggarrange(totcatch_SBC_CM, hatch_props_SBC_CM, nrow = 2, heights = c(4,5), align = "v")
ggsave("../figs/totcatch_hatchprops_SBC_CM.png", width = 18, height = 14, units = "cm")


```

The following code produces area density plots of catch distribution for BC CN (Figure 29) and BC CO (Figure 30) in the main report

```{r Catch Distribution Plots}
options(scipen = 999)

## ---- CN ----
# First group the catch  data into the 4 regions
CN_CatchbyFishery <- CN_dat  %>%
  filter(recY != 'NA') %>%
  select(recY, prod_area, 20:99) %>%
  pivot_longer(cols = 3:82, names_to = 'fishery', values_to = 'catch', values_drop_na = TRUE) %>%
  filter(! fishery %in% c("3Natural Spawners", "3Hatchery Removals", "3Rack First Nations", "3Rack Tendered"), !prod_area %in% c("TRAN", "YUKN")) %>%
  mutate(prod_area = case_when(prod_area %in% c("CCST", "RIVR") ~ "CCST",
                               prod_area %in% c("NCST", "QCI", "SKNA", "NASS") ~ "NCST",
                               prod_area %in% c("UPFR", "TOMF", "TOMM", "LWFR", "GSVI", "GSMN", "JNST", "OKAN") ~ "ISC",
                               prod_area %in% c("SWVI", "NWVI") ~ "WCVI",
                               TRUE ~ prod_area)) %>%
  group_by(prod_area, fishery, recY) %>%
  summarise(catch = sum(catch, na.rm = T)) %>%
  ungroup() 

# Remove the numbers in front of each fishery
CN_CatchbyFishery$fishery <- substring(CN_CatchbyFishery$fishery, 2) 


# To just get total annual CWT catch for all BC
CN_BC_CWT_catch <- CN_CatchbyFishery %>%
  group_by(recY) %>%
  summarise(total = sum(catch, na.rm = T))

# Overall total catch plot for BC CN
CN_CWT_catch <- ggplot(CN_BC_CWT_catch, aes(x = recY, y = total)) +
  geom_bar(stat = "identity", position = "dodge", colour = "black", size = 0.5) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(y = "Total Annual CWT Catch") +
  scale_x_continuous(expand = c(0,0), limits = c(1975, 2021)) +
  scale_y_continuous(expand = c(0,0), limits = c(0,410000), label = comma)
CN_CWT_catch

# Group some of the fisheries together into broader categories
CN_catchdist <- CN_CatchbyFishery %>%
  mutate(fishery = case_when(fishery %in% c("BC Unknown Freshwater", "Freshwater S", "Kamloops Lake") ~ "FW",
                             fishery %in% c("ADFG", "NMFS AK", "Alaskan Net (AK Catch, sampled by Canada)", "Alaskan Troll (Historical)") ~ "AK",
                             fishery %in% c("PFMA8 Terminal N", "Central N") ~ "Central N",
                             fishery %in% c("North Central T", "South Central T") ~ "Central T",
                             fishery %in% c("Juan de Fuca S", "Alberni Canal S", "WCVI S") ~ "WCVI S",
                             fishery %in% c("SWVI T", "NWVI T") ~ "WCVI T",
                             fishery %in% c("NWVI N", "Southwest Vancouver Is Net (Exc Alberni Inlet)", "SWVI N", "Juan de Fuca N", "Alberni Comm GN") ~ "WCVI N",
                             fishery %in% c("Fraser SN", "Fraser GN", "SOG N", "Johnstone Strait N") ~ "ISC N",
                             fishery %in% c("South Johnstone Strait S", "North SOG S", "South SOG S", "Central SOG S") ~ "ISC S",
                             fishery %in% c("Fraser FN (Fall-Winter)", "Fraser FN (Spring-Sum)", "Fraser FN Fall Winter Harrison to Thompson R (2011+)", "Fraser GN+FN (Fall-Winter)", "Fraser GN+FN (Spring-Sum)", "Bella Coola R FSC", "Cowichan R FSC", "Little Shuswap Lake FSC", "Lower Shuswap River FSC", "Middle Shuswap River FSC", "Alberni Inlet FSC Fishery", "Maa-Nulth FSC", "NWVI Taaq-Wiihak", "SWVI Taaq-Wiihak", "Other", "Terminal Other", "Terminal FN", "Nuu-chah-nulth", "BC Unknown Marine", "Skeena Test Fishery") ~ "Other",
                             grepl("Comb", fishery) ~ "Other",
                             fishery %in% c("ODFW", "WDFW", "WA Net (WA Catch, sampled by Canada)") ~ "SUS",
                             fishery == "SOG T" ~ "ISC T",
                             TRUE ~ fishery)) %>%
  mutate(fishery = factor(fishery, levels = c("AK", "Northern N", "Northern T", "Northern S", "Central N", "Central T", "Central S", "WCVI N", "WCVI T", "WCVI S", "ISC N", "ISC T", "ISC S", "FW", "SUS", "Other"))) %>%
  group_by(prod_area) %>%
  complete(fishery, recY, fill = list(catch = 0)) %>%
  group_by(recY, prod_area, fishery) %>%
  summarise(totcatch = sum(catch)) %>%
  group_by(recY, prod_area) %>%
  mutate(percentage = totcatch / sum(totcatch)) %>%
  replace(is.na(.),0) %>%
  arrange(recY, fishery) 
  
 


# Create a colour palette that's coloured by region from north to south with simplified fisheries 
fishery_cols_simple <- c("AK" = "red1", "Northern N" = "blue4", "Northern T" = "deepskyblue", "Northern S" = "skyblue", "Central N" = "mediumpurple1", "Central T" = "purple", "Central S" = "darkmagenta", "ISC T" = "green4", "ISC N" = "palegreen2", "ISC S" = "chartreuse2", "WCVI S" = "yellow", "WCVI T" = "orange", "WCVI N" = "lemonchiffon", "SUS" = "gray90", "FW" = "peru", "Other" = "gray5")


# Plot area density catch distribution for the province
CN_areaplot <- ggplot(CN_catchdist, aes(x = recY, y = percentage, fill = fishery)) +
  geom_area(alpha = 0.6, size = 0.4, colour = "black") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, "line"),
        legend.title = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = fishery_cols_simple, limits = force) +
  scale_x_continuous(expand = c(0,0), limits = c(1975, 2021)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Annual CWT Catch")
CN_areaplot
ggsave("../figs/harvest/CN/catch_by_fishery/BCwide_CN_catchbyfishery_areaplot.png", width = 16, height = 12, units = "cm")

#Combine above total CWT catch plot with the catch by fishery area plot to make Figure 29
ggarrange(CN_CWT_catch, CN_areaplot, nrow = 2, heights = c(5, 10), align = "v")
ggsave("../figs/distribution/BC_CWT_CN_catchdist_combo.png", width = 20, height = 18, units = "cm")



## ---- CO ----
# Creating boxplots of average annual catch in each fishery grouped by stock
CO_CatchbyFishery <- CO_dat %>%
  filter(recY != 'NA') %>%
  select(recY, prod_area, 20:86) %>%
  pivot_longer(cols = 3:69, names_to = 'fishery', values_to = 'catch', values_drop_na = TRUE) %>%
  filter(! fishery %in% c("3Natural Spawners", "3Hatchery Removals", "3Rack First Nations", "3Rack Tendered"), !prod_area %in% c("TRAN", "YUKN")) %>%
  mutate(prod_area = case_when(prod_area %in% c("CCST", "RIVR") ~ "CCST",
                               prod_area %in% c("NCST", "QCI", "SKNA", "NASS") ~ "NCST",
                               prod_area %in% c("UPFR", "TOMF", "TOMM", "LWFR", "GSVI", "GSMN", "GSMS", "JNST", "OKAN") ~ "ISC",
                               prod_area %in% c("SWVI", "NWVI") ~ "WCVI",
                               TRUE ~ prod_area)) %>%
  group_by(prod_area, fishery, recY) %>%
  summarise(catch = sum(catch)) %>%
  filter(catch > 0) %>%
  ungroup() 

CO_CatchbyFishery$fishery <- substring(CO_CatchbyFishery$fishery, 2) 

# To just get total annual CWT catch for all BC
CO_BC_CWT_catch <- CO_CatchbyFishery %>%
  group_by(recY) %>%
  summarise(total = sum(catch, na.rm = T))

# Overall total catch plot for BC CN
CO_CWT_catch <- ggplot(CO_BC_CWT_catch, aes(x = recY, y = total)) +
  geom_bar(stat = "identity", position = "dodge", colour = "black", size = 0.5) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(y = "Total Annual CWT Catch") +
  scale_x_continuous(expand = c(0,0), limits = c(1975, 2021)) +
  scale_y_continuous(expand = c(0,0), limits = c(0,700000), label = comma)
CO_CWT_catch



# create overall area density for CO province-wide
CO_catchdist <- CO_CatchbyFishery %>%
  mutate(fishery = case_when(fishery %in% c("Central Terminal N", "Central N", "PFMA8 Terminal N") ~ "Central N",
                             fishery %in% c("ADFG", "NMFS AK") ~ "AK",
                             fishery %in% c("North Central T", "South Central T") ~ "Central T",
                             fishery %in% c("Juan de Fuca S", "Alberni Canal S", "WCVI S") ~ "WCVI S",
                             fishery %in% c("SWVI T", "NWVI T", "Juan De Fuca Troll") ~ "WCVI T",
                             fishery %in% c("NWVI N", "SWVI N", "Juan de Fuca N", "Alberni Comm GN") ~ "WCVI N",
                             fishery %in% c("Fraser SN", "Fraser GN", "SOG N", "Johnstone Strait N") ~ "ISC N",
                             fishery %in% c("South Johnstone Strait S", "North SOG S", "South SOG S", "Central SOG S") ~ "ISC S",
                             fishery %in% c("Fraser FN (Fall-Winter)", "Fraser GN+FN (Fall-Winter)", "Fraser GN+FN (Spring-Sum)", "FSC", "NWVI Taaq-Wiihak", "SWVI Taaq-Wiihak", "Other", "Terminal Other", "Terminal FN", "Nuu-chah-nulth", "Skeena Test Fishery") ~ "Other",
                             fishery %in% c("ODFW", "Washington", "WDFW", "WA/OR Troll (Historical)", "California Dept of Fish and Game (CA)") ~ "SUS",
                             fishery == "SOG T" ~ "ISC T",
                             fishery == "Freshwater S" ~ "FW",
                             TRUE ~ fishery)) %>%
  mutate(fishery = factor(fishery, levels = c("AK", "Northern N", "Northern T", "Northern S", "Central N", "Central T", "Central S", "WCVI N", "WCVI T", "WCVI S", "ISC N", "ISC T", "ISC S", "FW", "SUS", "Other"))) %>%
  group_by(prod_area) %>%
  complete(fishery, recY, fill = list(catch = 0)) %>%
  group_by(recY, prod_area, fishery) %>%
  summarise(totcatch = sum(catch)) %>%
  group_by(recY) %>%
  mutate(percentage = totcatch / sum(totcatch)) %>%
  replace(is.na(.),0) %>%
  arrange(recY, fishery) 

# Create a colour palette that's coloured by region from north to south with simplified fisheries 
fishery_cols_simple <- c("AK" = "red1", "Northern N" = "blue4", "Northern T" = "deepskyblue", "Northern S" = "skyblue", "Central N" = "mediumpurple1", "Central T" = "purple", "Central S" = "darkmagenta", "ISC T" = "green4", "ISC N" = "palegreen2", "ISC S" = "chartreuse2", "WCVI S" = "yellow", "WCVI T" = "orange", "WCVI N" = "lemonchiffon", "SUS" = "gray90", "FW" = "peru", "Other" = "gray5")

# Plot area density catch distribution for the province
CO_areaplot <- ggplot(CO_catchdist, aes(x = recY, y = percentage, fill = fishery)) +
  geom_area(alpha = 0.6, size = 0.4, colour = "black") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, "line"),
        legend.title = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = fishery_cols_simple, limits = force) +
  scale_x_continuous(expand = c(0,0), limits = c(1975, 2021)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Annual CWT Catch")
CO_areaplot
ggsave("../figs/harvest/CN/catch_by_fishery/BCwide_CN_catchbyfishery_areaplot.png", width = 16, height = 12, units = "cm")


#Combine above total CWT catch plot with the catch by fishery area plot
ggarrange(CO_CWT_catch, CO_areaplot, nrow = 2, heights = c(5, 10), align = "v")
ggsave("../figs/distribution/BC_CWT_CO_catchdist_combo.png", width = 20, height = 18, units = "cm")



```

The following code produces area density plots for each species in each region (NCST, CCST, WCVI, and ISC) in Appendix B

```{r Catch Distributions Appendix B}
CN_catchdist_sum <- CN_catchdist %>%
  group_by(recY, prod_area) %>%
  summarise(regional_catch = sum(totcatch))

##---- NCST ----
# Create a total catch plot for each region to go above the catch by fishery area plots
NCST_CWT_catch <- ggplot(subset(CN_catchdist_sum, prod_area == "NCST"), aes(x = recY, y = regional_catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "black", size = 0.5) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(y = "Total Annual CWT Catch") +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0), limits = c(0,16000), labels = comma)
NCST_CWT_catch

NCST_areaplot <- ggplot(subset(CN_catchdist, prod_area == "NCST"), aes(x = recY, y = percentage, fill = fishery)) +
  geom_area(alpha = 0.6, size = 0.4, colour = "black") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, "line"),
        legend.title = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = fishery_cols_simple, limits = force) +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Annual CWT Catch")
#ggsave("../figs/distribution/NCST_CN_catchbyfishery_areaplot.png", width = 16, height = 12, units = "cm")

#Combine above total CWT catch plot with the catch by fishery area plot
ggarrange(NCST_CWT_catch, NCST_areaplot, nrow = 2, heights = c(5, 10), align = "v")
#ggsave("../figs/distribution/NCST_CN_catchdist_combo.png", width = 16, height = 16, units = "cm")



## ---- CCST ----
CCST_CWT_catch<- ggplot(subset(CN_catchdist_sum, prod_area == "CCST"), aes(x = recY, y = regional_catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "black", size = 0.5) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(y = "Total Annual CWT Catch") +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0), limits = c(0,12000), labels = comma)
CCST_CWT_catch

CCST_areaplot <- ggplot(subset(CN_catchdist, prod_area == "CCST"), aes(x = recY, y = percentage, fill = fishery)) +
  geom_area(alpha = 0.6, size = 0.4, colour = "black") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, "line"),
        legend.title = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = fishery_cols_simple, limits = force) +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Annual CWT Catch")
#ggsave("../figs/distribution/CCST_CN_catchbyfishery_areaplot.png", width = 16, height = 12, units = "cm")

#Combine above total CWT catch plot with the catch by fishery area plot
ggarrange(CCST_CWT_catch, CCST_areaplot, nrow = 2, heights = c(5, 10), align = "v")
#ggsave("../figs/distribution/CCST_CN_catchdist_combo.png", width = 16, height = 16, units = "cm")


## ---- WCVI ----
WCVI_CWT_catch<- ggplot(subset(CN_catchdist_sum, prod_area == "WCVI"), aes(x = recY, y = regional_catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "black", size = 0.5) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(y = "Total Annual CWT Catch") +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0), limits = c(0,280000), labels = comma)
WCVI_CWT_catch

WCVI_areaplot <- ggplot(subset(CN_catchdist, prod_area == "WCVI"), aes(x = recY, y = percentage, fill = fishery)) +
  geom_area(alpha = 0.6, size = 0.4, colour = "black") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, "line"),
        legend.title = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = fishery_cols_simple, limits = force) +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Annual CWT Catch")
#ggsave("../figs/distribution/WCVI_CN_catchbyfishery_areaplot.png", width = 16, height = 12, units = "cm")

#Combine above total CWT catch plot with the catch by fishery area plot
ggarrange(WCVI_CWT_catch, WCVI_areaplot, nrow = 2, heights = c(5, 10), align = "v")
ggsave("../figs/distribution/WCVI_CN_catchdist_combo.png", width = 16, height = 16, units = "cm")



## ---- ISC ----
ISC_CWT_catch<- ggplot(subset(CN_catchdist_sum, prod_area == "ISC"), aes(x = recY, y = regional_catch)) +
  geom_bar(stat = "identity", position = "dodge", colour = "black", size = 0.5) +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(y = "Total Annual CWT Catch") +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0), limits = c(0,120000), labels = comma)
ISC_CWT_catch

ISC_areaplot <- ggplot(subset(CN_catchdist, prod_area == "ISC"), aes(x = recY, y = percentage, fill = fishery)) +
  geom_area(alpha = 0.6, size = 0.4, colour = "black") +
  theme_bw() +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, "line"),
        legend.title = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = fishery_cols_simple, limits = force) +
  scale_x_continuous(expand = c(0,0), limits = c(1974, 2021)) +
  scale_y_continuous(expand = c(0,0)) +
  labs(y = "Proportion of Annual CWT Catch")
#ggsave("../figs/distribution/ISC_CN_catchbyfishery_areaplot.png", width = 16, height = 12, units = "cm")

#Combine above total CWT catch plot with the catch by fishery area plot
ggarrange(ISC_CWT_catch, ISC_areaplot, nrow = 2, heights = c(5, 10), align = "v")
ggsave("../figs/distribution/ISC_CN_catchdist_combo.png", width = 16, height = 16, units = "cm")


```


The following code produces figures 31 and 32 in the harvest report. Note there are several challenges in analysing data by production objective. Here, 'PP' is all Primary objectives for all Release lines of production from the 2014-2021 produciton plans combined. Upon manual inspection, there were several project-stock-run combinations that had more than one production objective over that time period. Therefore, I've manually assigned the objective that had the most releases to the relevant project-stock-run combination below. In addition, where an objective was "Assessment/Objective", I re-named them to be just the objective without Assessment. However, this process means that some objectives will be under/over-represented in the figures.


```{r Catch Efficiency}
# Catch efficiency: catch per release

## ---- CN ----
# Pull out CN production plan objectives from all years PPs. Some have multiple objectives so have manually assigned objectives for those specific stock-project-run combinations. Where there were >1 objective, I chose the one with the most target releases between 2014-2021.
CN_obj <- PP %>%
  filter(species == "Chinook") %>%
  select(proj = project, stock, run, obj) %>%
  distinct() %>%
  mutate(obj = case_when(obj == "Assessment/Harvest" ~ "Harvest",
                         obj == "Assessment/Rebuilding" ~ "Rebuilding",
                         obj == "Assessment/Conservation" ~ "Conservation",
                         obj %in% c("Stewardship", "Education", "Stewardship/Education") ~ "Stewardship & Education",
                         TRUE ~ obj)) %>%
  mutate(obj = case_when(stock == "Bulkley R Up" & proj == "Toboggan Cr" & run == "Spring" ~ "Rebuilding",
                         stock == "Chilko R" & proj == "Chehalis R" & run == "Summer" ~ "Rebuilding",
                         stock == "Chilko R" & proj == "Inch Cr" & run == "Summer" ~ "Assessment",
                         stock == "Chilko R" & proj == "Spius Cr" & run == "Summer" ~ "Rebuilding",
                         stock == "Cowichan R" & proj == "Cowichan R" & run == "Fall" ~ "Conservation",
                         stock == "Gold R" & proj == "Conuma R" & run == "Fall" ~ "Harvest & Rebuilding",
                         stock == "Nicola R" & proj == "Spius R" & run == "Spring" ~ "Rebuilding",
                         stock == "Nitinat R" & proj == "Nitinat R" & run == "Fall" ~ "Harvest",
                         stock == "Nitinat R" & proj == "Sooke R" & run == "Fall" ~ "Harvest",
                         stock == "Portage R" & proj == "Tenderfoot Cr" & run == "Summer" ~ "Conservation",
                         stock == "Quinsam R" & proj == "Quinsam R" & run == "Fall" ~ "Harvest",
                         stock == "Robertson Cr" & proj == "Robertson Cr" & run == "Fall" ~ "Harvest",
                         stock == "San Juan R" & proj == "San Juan R" & run == "Fall" ~ "Rebuilding",
                         stock == "Sarita R" & proj == "Nitinat R" & run == "Fall" ~ "Rebuilding",
                         stock == "Shuswap R Middle" & proj == "Shuswap R Middle" & run == "Summer" ~ "Assessment",
                         stock == "Sooke R" & proj == "Sooke R" & run == "Fall" ~ "Harvest",
                         TRUE ~ obj))

# Tidy up hatchery catch data
CN_data <- CN_dat %>%
  select(proj = project, species, run, stock, prod_area, tagcode, OEY, TotRelease, TotCatch, Escape) %>%
  distinct()

# Combine objectives with the catch data from EPAD (expanded catches)
CN_obj_catch <- left_join(CN_data, CN_obj, by = c("proj", "stock", "run")) 

# ANNUAL REGIONAL: Tidy data, group into areas, calculate catch per thousand releases per area per year
Eff_CN_annual <- CN_obj_catch %>%
  filter(!prod_area %in% c("TRAN", "YUKN")) %>%
  mutate(prod_area = case_when(prod_area %in% c("CCST", "RIVR") ~ "CCST",
                               prod_area %in% c("NCST", "QCI", "SKNA", "NASS") ~ "NCST",
                               prod_area %in% c("UPFR", "TOMF", "TOMM", "GSMS", "GSMN", "GSVI", "JNST", "LWFR", "OKAN") ~ "ISC",
                               prod_area %in% c("SWVI", "NWVI") ~ "WCVI",
                               TRUE ~ prod_area)) %>%
  mutate(obj = case_when(is.na(obj) ~ "Unknown",
                         TRUE ~ obj)) %>%
  mutate(obj = factor(obj, levels = c("Assessment", "Harvest", "Rebuilding", "Conservation", "Stewardship & Education", "Unknown"))) %>%
  group_by(prod_area, tagcode, obj, OEY) %>%
  summarise(totrel = sum(unique(TotRelease)), totcatch = sum(unique(TotCatch), na.rm = T), totescape = sum(unique(Escape), na.rm = T), CPthousandR = (totcatch/(totrel/1000)), EPthousandR = totescape/(totrel/1000)) %>%
  group_by(prod_area, obj, OEY) %>%
  mutate(median_CPT = median(CPthousandR), sd = sd(CPthousandR)) %>%
  select(1, 3:4, 10:11) %>%
  distinct() %>%
  arrange(prod_area, obj, OEY) %>%
  mutate(prod_area = factor(prod_area, levels = c("NCST", "CCST", "WCVI", "ISC"))) %>%
  filter(median_CPT < 100) %>%
  arrange(obj, prod_area, OEY)


# Adding a grouping variable to consecutive years of data so that years with no data are not connected
idx <- c(1, diff(Eff_CN_annual$OEY))
i2 <- c(1,which(idx != 1), nrow(Eff_CN_annual)+1)
Eff_CN_annual$grp <- rep(1:length(diff(i2)), diff(i2))


# Colour palette
obj_cols <- c("Assessment" = "goldenrod3", "Harvest" = "steelblue", "Rebuilding" = "mediumseagreen", "Conservation" = "mediumpurple4", "Stewardship & Education" = "violetred2", "Unknown" = "grey50")

# Plot catch per thousand releases by obj by prod_area
ggplot(Eff_CN_annual, aes(x = OEY, group = grp)) + 
  geom_line(aes(y = median_CPT, color = obj), size = 1.5) +
  geom_ribbon(aes(y = median_CPT, ymin = ifelse(median_CPT - sd < 0, 0, median_CPT - sd), ymax = median_CPT + sd, fill = obj), alpha = 0.3) +
  facet_wrap(~prod_area, scales = "free_y") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.position = "top",
        legend.key.size = unit(0.9, "line"))+
  labs(y = "Catch/1000 Released") +
  scale_color_manual(values = obj_cols) +
  scale_fill_manual(values = obj_cols) 
# To produce Figure 31:
ggsave("../figs/catch_efficiency_CN.png", width = 19, height = 15, units = "cm")



## ---- CO ----
# Pull out CO production plan objectives
CO_obj <- PP %>%
  filter(species == "Coho") %>%
  select(proj = project, stock, run, stage, obj) %>%
  distinct() %>%
  mutate(obj = case_when(obj == "Assessment/Harvest" ~ "Harvest",
                         obj == "Assessment/Conservation" ~ "Conservation",
                         obj %in% c("Stewardship", "Education", "Stewardship/Education") ~ "Stewardship & Education",
                         TRUE ~ obj)) %>%
  mutate(obj = case_when(stock == "Capilano R" & proj == "Capilano R" ~ "Harvest",
                         stock == "Conuma R" & proj == "Conuma R" ~ "Harvest",
                         stock == "Coal Cr" & proj == "Fanny B/GSVI" ~ "Harvest",
                         stock == "Wilfred Cr (Coal)" & proj == "Fanny B/GSVI" ~ "Stewardship & Education",
                         stock == "Goldstream R" & proj == "Goldstream R" ~ "Harvest",
                         stock == "Kanaka Cr" & proj == "Kanaka Cr" ~ "Harvest",
                         stock == "L Campgell R" & proj == "L Campbell R" ~ "Harvest",
                         stock == "Little R/GSVI" & proj == "Little R/GSVI" ~ "Rebuilding",
                         stock == "Nitinat R" & proj == "Nitinat R" ~ "Harvest",
                         stock == "Oyster R" & proj == "Oyster R" ~ "Stewardship & Education",
                         stock %in% c("Marble R", "Washlawlis R", "Cluxewe R", "Quatse R", "Waukwaas Cr") & proj == "P Hardy/Marble" ~ "Harvest",
                         stock == "Coquitlan R" & proj == "Poco Hatchery" ~ "Stewardship & Education",
                         stock == "Puntledge R" & proj == "Puntledge R" ~ "Rebuilding",
                         stock == "Quinsam R" & proj == "Quinsam R" ~ "Harvest",
                         stock == "Robertson Cr" & proj == "Robertson Cr" ~ "Harvest",
                         stock %in% c("Coldwater R", "Eagle R") & proj == "Spius Cr" ~ "Conservation",
                         stock == "Mamquam R" & proj == "Tenderfoot Cr" ~ "Harvest",
                         stock == "Tenderfoot Cr" & proj == "Tenderfoot Cr" ~ "Rebuilding",
                         stock == "Toboggan Cr" & proj == "Toboggan Cr" ~ "Assessment",
                         TRUE ~ obj))
 

# Tidy up hatchery catch data
CO_data <- CO_dat %>%
  select(proj = project, species, run, stock, prod_area, tagcode, OEY, TotRelease, TotCatch, Escape) %>%
  distinct()
                        
                         
# Combine them with the CO_catch data from EPAD (expanded catches)
CO_obj_catch <- left_join(CO_data, CO_obj, by = c("proj", "stock", "run")) 

# ANNUAL REGIONAL: Tidy data, group into areas, calculate catch per thousand releases per area per year
Eff_CO_annual <- CO_obj_catch %>%
  filter(!prod_area %in% c("TRAN", "YUKN")) %>%
  mutate(prod_area = case_when(prod_area %in% c("CCST", "RIVR") ~ "CCST",
                               prod_area %in% c("NCST", "QCI", "SKNA", "NASS") ~ "NCST",
                               prod_area %in% c("UPFR", "TOMF", "TOMM", "GSMS", "GSMN", "GSVI", "JNST", "LWFR", "OKAN") ~ "ISC",
                               prod_area %in% c("SWVI", "NWVI") ~ "WCVI",
                               TRUE ~ prod_area)) %>%
  mutate(obj = case_when(is.na(obj) ~ "Unknown",
                         TRUE ~ obj)) %>%
  mutate(obj = factor(obj, levels = c("Assessment", "Harvest", "Rebuilding", "Conservation", "Stewardship & Education", "Unknown"))) %>%
  group_by(prod_area, tagcode, obj, OEY) %>%
  summarise(totrel = sum(unique(TotRelease)), totcatch = sum(TotCatch, na.rm = T), totescape = sum(Escape, na.rm = T), CPthousandR = (totcatch/(totrel/1000)), EPthousandR = totescape/(totrel/1000)) %>%
  group_by(prod_area, obj, OEY) %>%
  mutate(median_CPT = median(CPthousandR), sd = sd(CPthousandR)) %>%
  select(1, 3:4, 10:11) %>%
  distinct() %>%
  arrange(prod_area, obj, OEY) %>%
  mutate(prod_area = factor(prod_area, levels = c("NCST", "CCST", "WCVI", "ISC"))) %>%
  filter(median_CPT < 100) %>%
  arrange(obj, prod_area, OEY)

# Adding a grouping variable to consecutive years of data so that years with no data are not connected
idx <- c(1, diff(Eff_CO_annual$OEY))
i2 <- c(1,which(idx != 1), nrow(Eff_CO_annual)+1)
Eff_CO_annual$grp <- rep(1:length(diff(i2)), diff(i2))


# Colour palette
obj_cols <- c("Assessment" = "goldenrod3", "Harvest" = "steelblue", "Rebuilding" = "mediumseagreen", "Conservation" = "mediumpurple4", "Stewardship & Education" = "violetred2", "Unknown" = "grey50")

# Plot catch per thousand releases by obj by prod_area
CO_efficiency <- ggplot(Eff_CO_annual, aes(x = OEY, group = grp)) + 
  geom_line(aes(y = median_CPT, color = obj), size = 1.5) +
  geom_ribbon(aes(y = median_CPT, ymin = ifelse(median_CPT - sd < 0, 0, median_CPT - sd), ymax = median_CPT + sd, fill = obj), alpha = 0.3) +
  facet_wrap(~prod_area, scales = "free_y") +
  theme_bw() +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.position = "top",
        legend.key.size = unit(0.9, "line"))+
  labs(y = "Catch/1000 Released") +
  scale_color_manual(values = obj_cols) +
  scale_fill_manual(values = obj_cols) 
CO_efficiency
# To produce Figure 32
ggsave("../figs/catch_efficiency_CO.png", width = 19, height = 15, units = "cm")

```









